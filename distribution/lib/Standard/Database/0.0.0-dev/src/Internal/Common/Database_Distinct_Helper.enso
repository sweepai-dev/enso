from Standard.Base import all

from Standard.Table.Errors import Floating_Point_Equality

import project.Internal.Helpers
import project.Internal.IR.SQL_Expression.SQL_Expression

## PRIVATE
make_distinct_expression text_case_sensitivity problem_builder key_column =
    # TODO we need to be able to access column Value_Type from here!
    # may need to promote the Internal_Column to Column
    sql_type = key_column.sql_type_reference.get
    if sql_type.is_definitely_double then
        problem_builder.report_other_warning (Floating_Point_Equality.Error key_column.name)

    expr = key_column.expression

    if sql_type.is_definitely_text.not then expr else case text_case_sensitivity of
        Case_Sensitivity.Insensitive locale ->
            Helpers.assume_default_locale locale <|
                SQL_Expression.Operation "FOLD_CASE" [expr]
        Case_Sensitivity.Sensitive -> SQL_Expression.Operation "MAKE_CASE_SENSITIVE" [expr]
        Case_Sensitivity.Default -> expr
